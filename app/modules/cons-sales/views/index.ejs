<%- include('../../../templates/consignor-dashboard.ejs') -%>

<!-- <style>
  #sales-nav-pane > div:first-child > a:nth-child(2),
  #sales-nav-pane > div:first-child > a:nth-child(2) *  {
    background: var(--primary-color);
    color: white;
  }
</style> -->

<div id="sales-container" class="container">
  <div class="row">
    <div id="sales-nav-pane" class="p-0">
      <div>
        <div>
          <p class="m-0 fw-400 lh-p3em">All Sales</p>
        </div>
        <div>
          <a id="thisWeekBtn" class="no-decoration cursor-pointer">
            <div class="sales-link">
              <p class="fs-09em fw-400 mb-0 px-3">This Week</p>
            </div>
          </a>
          <a id="thisMonthBtn" class="no-decoration cursor-pointer">
            <div class="sales-link">
              <p class="fs-09em fw-400 mb-0 px-3">This Month</p>
            </div>
          </a>
          <a id="thisYearBtn" class="no-decoration cursor-pointer">
            <div class="sales-link">
              <p class="fs-09em fw-400 mb-0 px-3">This Year</p>
            </div>
          </a>
        </div>
      </div>
      <div>
        <p class="fs-09em fw-400 mb-0">
          <i class="fa fa-filter dateFilterIcon cursor-pointer" title="Use Filter"></i> Select Date
        </p>
        <select id="month-filter" class="mb-1 custom-select" name="">
          <option value="0">Month</option>
        </select>
        <select id="year-filter" class="mb-2 custom-select" name="">
          <option value="0">Year</option>
        </select>
        <!-- <button type="button" name="button" class="btn btn-sm btn-custom-primary btn-block">Submit</button> -->

      </div>
    </div>
    <div id="sales-main-pane" class="col-xs-12 col-sm p-0">
      <div class="row m-0 pb-0">
        <div class="col-xs-12 col-sm"><p class="fs-09em fw-400 mb-0">This Week</p></div>
        <div class="col-xs-12 col-sm"><p class="fs-09em fw-400 mb-0">Products Sold: <span>0</span></p></div>
        <div class="col-xs-12 col-sm"><p class="fs-09em fw-400 mb-0">Total Sales : <span class="price-symbol price-color">0.00</span></p></div>
      </div>
      <div class="row m-0 text-muted py-0">
        <div class="col-xs-12 col-sm"><p class="fs-09em fw-400 mb-0 text-muted">Previous Week</p></div>
        <div class="col-xs-12 col-sm"><p class="fs-09em fw-400 mb-0 text-muted">Products Sold: <span>0</span></p></div>
        <div class="col-xs-12 col-sm"><p class="fs-09em fw-400 mb-0 text-muted">Total Sales : <span class="price-symbol">0.00</span></p></div>
      </div>
      <div>
        <div id="header" class="px-3 py-1">
          <div class="products-col inline-block">
            <p class="inline m-0 fs-08em fw-400">Product</p>
          </div>
          <div class="price-col inline-block align-right">
            <p class="inline m-0 fs-08em fw-400">Price</p>
          </div>
          <div class="quantity-col inline-block align-right">
            <p class="inline m-0 fs-08em fw-400">Qty</p>
          </div>
          <div class="sales-col inline-block align-right">
            <p class="inline m-0 fs-08em fw-400">Sales</p>
          </div>
        </div>
        <div id="products-container" style="padding-bottom: 0px;">
          <!-- products & inv -->
          <div style="padding: 15px 15px 0px">
            <p class="fs-09em inline-block va-t"> Loading Products </p>
            <svg version="1.1" id="SVG_loadList" class="inline-block">
              <rect x="0" y="0" width="4" height="10">
                <animateTransform attributeType="xml"
                  attributeName="transform" type="translate"
                  values="0 0; 0 10; 0 0"
                  begin="0" dur="0.6s" repeatCount="indefinite" />
              </rect>
              <rect x="8" y="0" width="4" height="10">
                <animateTransform attributeType="xml"
                  attributeName="transform" type="translate"
                  values="0 0; 0 10; 0 0"
                  begin="0.2s" dur="0.6s" repeatCount="indefinite" />
              </rect>
              <rect x="16" y="0" width="4" height="10">
                <animateTransform attributeType="xml"
                  attributeName="transform" type="translate"
                  values="0 0; 0 10; 0 0"
                  begin="0.4s" dur="0.6s" repeatCount="indefinite" />
              </rect>
            </svg>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('../../../templates/scripts.ejs') -%>
<%- include('../../../templates/scripts-customer.ejs') -%>
<script src="/customer-assets/scripts/pagination/jquery.twbsPagination.js" type="text/javascript"></script>
<script type="text/javascript">
$(()=>{
  const thisUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}`;
  let newUrl, $pagination = $('#pagination'), defaultOpts = { totalPages: 1 };
  $pagination.twbsPagination(defaultOpts);

  function getParams(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, '\\$&');
    let regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
    results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  }
  function pushParams(filterBy,fMonth,fYear){
    filterBy != null ? 0 : filterBy = getParams('filterBy');
    fMonth != null ? 0 : null;
    fYear != null ? 0 : null;
    newUrl = `${thisUrl}`;

    newUrl = filterBy ? `${newUrl}?filterBy=${filterBy}` : `${newUrl}?filterBy=thisWeek`;
    newUrl = fMonth ? `${newUrl}&fMonth=${fMonth}` : `${newUrl}`;
    newUrl = fYear ? `${newUrl}&fYear=${fYear}` : `${newUrl}`;

    window.history.pushState({path:newUrl},'',newUrl);
  }

  function loadSales(){
    let filterBy = getParams('filterBy'), fMonth = getParams('fMonth'),
     fYear = getParams('fYear');

    if(!filterBy){
      newUrl = `${thisUrl}?filterBy=thisWeek`;
      window.history.pushState({path:newUrl},'',newUrl);
      filterBy = 'thisWeek';
    }

    filterBy ? filterBy = filterBy.indexOf("'") == -1 ? filterBy : 'thisWeek' : 0;
    fMonth ? fMonth = fMonth.indexOf("'") == -1 ? fMonth : null : 0;
    fYear ? fYear = fYear.indexOf("'") == -1 ? fYear : null : 0;

    // filters design
    $('#sales-nav-pane > div:first-child > div:nth-child(2) > a').removeClass('selected');
    switch (filterBy) {
      case 'thisWeek': $('#thisWeekBtn').addClass('selected'); break;
      case 'thisMonth': $('#thisMonthBtn').addClass('selected'); break;
      case 'thisYear': $('#thisYearBtn').addClass('selected'); break;
    }
    if (filterBy == 'specialDate'){
      $('.dateFilterIcon').css('color','var(--primary-color)')
      $('.dateFilterIcon').attr('title','Filter is Active')
    }
    else {
      $('.dateFilterIcon').css('color','rgba(0,0,0,.3)')
      $('.dateFilterIcon').attr('title','Use Filter')
    }

    // loading
    let list = $(`#products-container`);
    list.html(`
      <div style="padding: 15px 15px 0px">
        <p class="fs-09em inline-block va-t"> Loading Products </p>
        <svg version="1.1" id="SVG_loadList" class="inline-block">
          <rect x="0" y="0" width="4" height="10">
            <animateTransform attributeType="xml"
              attributeName="transform" type="translate"
              values="0 0; 0 10; 0 0"
              begin="0" dur="0.6s" repeatCount="indefinite" />
          </rect>
          <rect x="8" y="0" width="4" height="10">
            <animateTransform attributeType="xml"
              attributeName="transform" type="translate"
              values="0 0; 0 10; 0 0"
              begin="0.2s" dur="0.6s" repeatCount="indefinite" />
          </rect>
          <rect x="16" y="0" width="4" height="10">
            <animateTransform attributeType="xml"
              attributeName="transform" type="translate"
              values="0 0; 0 10; 0 0"
              begin="0.4s" dur="0.6s" repeatCount="indefinite" />
          </rect>
        </svg>
      </div>`);
    list.css('padding-bottom','0px');

    // load sales
    let tLoadSales = setTimeout(()=>{
      postSales();
    },400);

    function postSales(){
      $.post(`/consignorSales/loadSales`, {
        filterBy: filterBy, month: fMonth, year: fYear
      }).then((res) => {
        list.html('')
        let countCurrent = res.salesCountCurrent, countPrevious = res.salesCountPrevious,
        products = res.salesProducts, inv = res.salesInv, config = res.config

        // filters design
        $('#sales-nav-pane > div:first-child > div:nth-child(2) > a').removeClass('selected');
        switch (config.filterBy) {
          case 'thisWeek': $('#thisWeekBtn').addClass('selected'); break;
          case 'thisMonth': $('#thisMonthBtn').addClass('selected'); break;
          case 'thisYear': $('#thisYearBtn').addClass('selected'); break;
        }
        if (config.filterBy != 'specialDate'){
          $('.dateFilterIcon').css('color','rgba(0,0,0,.3)')
          $('.dateFilterIcon').attr('title','Use Filter')
        }

        // sales filter
        $('#month-filter').html('');
        $('#year-filter').html('');
        if (config.months[0]){
          $('#month-filter').append(`<option value="All">All Months</option>`);
        }
        else {
          $('#month-filter').append(`<option value="0">Month</option>`);
          $('#year-filter').append(`<option value="0">Year</option>`);
        }
        config.months.forEach((month)=>{
          month.month == fMonth ?
            $('#month-filter').append(`<option value="${month.month}" selected>${month.monthname}</option>`):
            $('#month-filter').append(`<option value="${month.month}">${month.monthname}</option>`)
        })
        config.years.forEach((year)=>{
          $('#year-filter').append(`<option value="${year.year}">${year.year}</option>`)
        })

        // sales summary
        $(`#sales-main-pane > div:first-child > div:first-child > p`).text(config.curSel);
        $(`#sales-main-pane > div:nth-child(2) > div:first-child > p`).text(config.prevSel);
        $(`#sales-main-pane > div:first-child > div:nth-child(2) span`).text(countCurrent[0].QtySold);
        $(`#sales-main-pane > div:first-child > div:nth-child(3) span`).text(countCurrent[0].TotalPrice);
        if(countPrevious[0].TotalPrice){
          $(`#sales-main-pane > div:nth-child(2) > div:nth-child(2) span`).text(countPrevious[0].QtySold);
          $(`#sales-main-pane > div:nth-child(2) > div:nth-child(3) span`).text(countPrevious[0].TotalPrice);
        }
        else{
          $(`#sales-main-pane > div:nth-child(2) > div:nth-child(2) span`).text('0');
          $(`#sales-main-pane > div:nth-child(2) > div:nth-child(3) span`).text('0.00');
        }

        // products & inv
        products[0] ? 0 : list.html(`
          <p class="fs-09em fw-400em" style="padding: 15px 15px 0px"><em>No Records Found</em></p>`);
        list.css('padding-bottom','15px');
        products.forEach((thisProd)=>{
          prodString = `
            <div class="product-div">
              <a href="/item/1000" class="img-link">
                <img src="/assets/images/products/${thisProd.strProductPicture}" height="100" width="100" alt="product">
              </a>
              <div class="prod-row">
                <div class="inline-block va-t">
                  <p class="m-0 fs-09em fw-400 lh-p3em"><span class="text-brand">${thisProd.strBrand}</span> ${thisProd.strProductName}</p>
                  <div class="product-sales-details block-none">
                    <p class="mb-0 fs-09em fw-400 lh-p3em">Quantity: ${thisProd.QtySold}</p>
                    <p class="mb-0 fs-09em fw-400 lh-p3em">Sales: <span class="price-symbol price-color">${thisProd.TotalPrice}</span></p>
                    <button type="button" name="button" class="btn btn-sm btn-custom-primary mt-1">More Details</button>
                  </div>
                </div>
                <div class="inline-block va-t align-right">
                  <p class="mb-0 fs-09em fw-400 lh-p3em"></p>
                </div>
                <div class="inline-block va-t align-right">
                  <p class="mb-0 fs-09em fw-400 lh-p3em">${thisProd.QtySold}</p>
                </div>
                <div class="inline-block va-t align-right">
                  <p class="mb-0 fs-09em fw-400 price-symbol price-color lh-p3em">${thisProd.TotalPrice}</p>
                </div>
              </div>`;
          inv.forEach((thisInv)=>{
            if (thisInv.intProductNo == thisProd.intProductNo){
              prodString = prodString.concat(`
                <div class="prod-row sizes" style="line-height: 1em;">
                  <div class="inline-block va-t">
                    <p class="m-0 fs-08em fw-400 text-muted">${thisInv.curSize}</p>
                  </div>
                  <div class="inline-block va-t align-right">
                    <p class="mb-0 fs-08em fw-400 text-muted">${thisInv.purchasePrice}</p>
                  </div>
                  <div class="inline-block va-t align-right">
                    <p class="mb-0 fs-08em fw-400 text-muted">${thisInv.QtySold}</p>
                  </div>
                  <div class="inline-block va-t align-right">
                    <p class="mb-0 fs-08em fw-400 text-muted">${thisInv.TotalPrice}</p>
                  </div>
                </div>`);
            }
          });
          prodString = prodString.concat(`
            </div>`);
          list.append(prodString);
        })
        console.log(res);
      }).catch((error) => {
        console.log(error);
      });
    }

  }

  $(`#thisWeekBtn`).click(function(){
    pushParams('thisWeek')
    loadSales()
  });
  $(`#thisMonthBtn`).click(function(){
    pushParams('thisMonth')
    loadSales()
  });
  $(`#thisYearBtn`).click(function(){
    pushParams('thisYear')
    loadSales()
  });

  $(`#month-filter`).change(function(){
    console.log($(this).val())
    pushParams('specialDate',$('#month-filter').val(),$('#year-filter').val())
    loadSales()
  });
  $(`#year-filter`).change(function(){
    pushParams('specialDate',$('#month-filter').val(),$('#year-filter').val())
    loadSales()
  });

  $('.dateFilterIcon').click(function(){
    pushParams('specialDate',$('#month-filter').val(),$('#year-filter').val())
    loadSales()
  });

  loadSales();
});

</script>
<%- include('../../../templates/closer.ejs') -%>

const express = require('express');
const router = express.Router();
const db = require('../../lib/database')();

function checkUser(req, res, next){
  if(!req.user){
    req.session.pendRoute = 1;
    req.flash('regSuccess', 'Login to view Account Information');
    res.redirect('/login');
  }
  else{
    req.session.pendRoute = 0;
    return next();
  }
}

function contactDetails (req, res, next){
  db.query(`SELECT * FROM tbluser
    INNER JOIN tblcustomer ON tbluser.intUserID= tblcustomer.intUserID
    WHERE tbluser.intUserID= ?`,[req.user.intUserID], (err, results, fields) => {
    if (err) console.log(err);
    req.contactDetails = results[0];
    return next();
  });
}

router.get('/dashboard', checkUser, contactDetails, (req,res)=>{
  res.render('cust-account/views/dashboard', {thisUser: req.user, thisUserContact: req.contactDetails});
});
router.get('/orders', checkUser, (req,res)=>{
  res.render('cust-account/views/orders', {thisUser: req.user});
});
router.get('/payment', checkUser, (req,res)=>{
  res.render('cust-account/views/payment', {thisUser: req.user});
});
router.get('/cancellations', checkUser, (req,res)=>{
  res.render('cust-account/views/cancellations', {thisUser: req.user});
});

router.post('/dashboard/info', checkUser, (req,res)=>{
  db.beginTransaction(function(err) {
    if (err) console.log(err);
    db.query(`UPDATE tbluser SET strFname= ?, strMname= ?, strLname= ?, strEmail= ? WHERE intUserID= ?`,
      [req.body.fname, req.body.mname, req.body.lname, req.body.email, req.user.intUserID], (err, results, fields) => {
      if (err) console.log(err);
      db.query(`UPDATE tblcustomer SET strShippingAddress= ?, strBillingAddress= ?, strCusPhoneNo= ?, strCusMobileNo= ? WHERE intUserID= ?`,
        [req.body.dsa, req.body.dba, req.body.phone, `0${req.body.mobile}`, req.user.intUserID], (err, results, fields) => {
        if (err) console.log(err);
        db.commit(function(err) {
          if (err) console.log(err);
          res.redirect('/account/dashboard');
        });
      });
    });
  });
});

exports.account = router;

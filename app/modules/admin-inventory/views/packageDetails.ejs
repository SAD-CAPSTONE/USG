<%- include('../../../templates/admin-navbar.ejs') -%>


<!-- Content Wrapper. Contains page content -->

<div class="content-wrapper">
 <!-- Content Header (Page header) -->
 <section class="content-header">
   <h1>

     <small>Note: You can add a package to a product in inventory.</small>
   </h1>
   <ol class="breadcrumb">
     <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
     <li><a href="#">Inventory</a></li>
     <li class="active">Packages</li>

   </ol>
 </section>

 <!-- Main content -->
 <section class="content">
   <div class="row">
     <div class="col-xs-12">
       <div class="box">
         <div class="box-header">
           <h3 class="box-title">Package No. <%= re[0].intPackageNo %></h3>
         </div>

         <form id="packageForm">
           <div class="box-body">
		<!-- buttons -->
        <div class="row">
          <div class="col-sm-10">

              <input type="hidden" name="packageNo" value="<%=re[0].intPackageNo%>">
              <div class="form-group">
                <label for="pname">Package Name:</label>
                <input type="text" value="<%=re[0].strPackageName%>" required class="form-control" name="pname" placeholder="">
              </div>

              <div class="form-group">
                <label for="pdesc">Package Description:</label>
                <textarea class="form-control" value="<%=re[0].strPackageDescription%>" name="pdesc" placeholder=""><%=re[0].strPackageDescription%></textarea>
              </div>

              <div class="form-group">
                <label for="pprice">Package Price</label>
                <input type="decimal" value="<%= re[0].packagePrice.toFixed(2)%>" required class="form-control" id="suggestedPrice" name="pprice" placeholder="">
                <small class="text-blue">this will be the price of the products included.</small>
              </div>

              <div class="form-group">
                <label for="pprice">Package Quantity</label>
                <input type="number" value="<%=re[0].intQuantity%>" required class="form-control"  name="pquantity" placeholder="">

              </div>

              <div class="form-group">
                <label for="pdue">Due Date</label>
                <input type="date" required value="<%=moment(re[0].dateDue).format("YYYY-MM-DD")%>" class="form-control" name="pdue" >
              </div>

          </div>
        </div>

          </br>
          <div class="row">
            <div class="col-sm-12">
              <div class="special-position-1" style="position: absolute">

                <a href="/inventory/packageList?package=<%=re[0].intPackageNo%>"><button type="button" class="large ui green button" > Edit Product List</button></a>
                <small class="text-green">Note: The package price updates everytime you change the product quantity in the list</small>
              </div>
            </div>
          </div>

             <!-- /.box-header -->
             <div class="box-body table-responsive">
               <table id="example3" class="table no-margin table-bordered table-hover">
                 <thead class="bg-success">
                 <tr>
                   <th></th>
                   <th>Product Name</th>
                   <th>Price</th>
                   <th>Quantity</th>


                 </tr>
                 </thead>
                 <tbody>
                  <% if (re == null || re == undefined){ %>

                  <% }else if(re.length == 0){ %>

                  <% }else{ %>
                    <% re.forEach(function(i){ %>
                      <tr>
                        <td>
                          <input type="hidden" class="form-control" value="<%=i.intPackageListNo%>" name="product[]">
                          <img  width="40px" height="40px" src="/assets/images/products/<%=i.strProductPicture%>">
                        </td>
                        <td><%=i.strProductName%> <%=i.strVariant%> <%= i.intSize%>  <%=i.strUnitName%></td>
                        <td><%= i.productPrice %><input type="hidden" value="<%= i.productPrice %>" class="price"></td>
                        <td><input  type="number" value="<%=i.intProductQuantity%>" name="quantity[]" class="quantity form-control"></td>


                      </tr>
                    <% }) %>
                  <% } %>


                 </tbody>

               </table>
             </div>
             <!-- /.box-body -->
        </div>
        <div class="box-footer">
          <button class="large ui button pull-left" >Back</button>
          <button type="submit" class="large ui teal button pull-right">Submit</button>
        </div>
      </form>

       </div>
       <!-- /.box -->

    </div>
     <!-- /.col -->
   </div>
   <!-- /.row -->
 </section>
 <!-- /.content -->
</div>

<!-- /.content-wrapper -->

<!-- Modals -->




<%- include('../../../templates/admin-aside.ejs') -%>

<!-- ./wrapper -->

<%- include('../../../templates/admin-footer.ejs') -%>


<!-- page script (new added) -->

<script>
$('.quantity').on('keyup',function(){
  totalValue = 0;

  $('table').find('input.quantity').each(function(){
    totalValue = parseInt(totalValue) +  ($(this).val() * parseInt($(this).closest('tr').find('input.price').val()));
  })
  $('#suggestedPrice').val(totalValue)

})



</script>

<script>
  $('#packageForm').submit(function(e){
    e.preventDefault();
    $.post('/inventory/editPackage2', $('#packageForm').serialize(), function(data,status){
      if(data=="yes"){
        swal({
          title: "Warning!",
          text: "Note: Prices of the products included in this list might have changed, you may want to change the price too.",
          type: "warning",
          showCancelButton: true,
          confirmButtonText: "No, Proceed",
          cancelButtonText: "Back",
          reverseButtons: true
        }).then((result)=>{
          if(result.value){
            swal({title: 'Success!', type: 'success'}).then(()=>{
              location.reload();
            })
          }else{

          }
        })

      }
      else if(data=="noItems"){
        swal({title: 'Error!', text: 'Your package is empty. Add products in this package', type: 'error'}).then(()=>{

        })
      }
      else{

        swal({title: 'Error!', text: 'You do not have enough stocks to transfer to package', type: 'error'}).then(()=>{

        })
      }
    })
  })
</script>





<script>
  $(function () {
    $('#example3').DataTable({
      'paging'      : false,
      'lengthChange': true,
      'searching'   : true,
      'ordering'    : true,
      'info'        : true,
      'autoWidth'   : true,
	  'select'		: true,
	  'scroll'		: true
    })
  })
</script>

<script>
  $('#title').html("USG | Packages");
  $(".treeview a:contains('Inventory')").parent().addClass("active");
  $(".navi a:contains('Packages')").parent().addClass("active");
</script>

<script>
$('#starthelpBlock').show();
$('#successhelpBlock').hide();
$('#errorhelpBlock').hide();
$('#save').attr('disabled',true);

var temp_response = "";

  $('.addList').on('click',function(){
    temp_response = "";
    $('#barcode').val("")


  })


  $('#barcode').on('keyup',function(){

    $.post('/inventory/packageGetBarcode',{o: $('#barcode').val()},function(response,status){

      if(response=="error"){
        $('#form-group').attr('class', 'form-group has-error');
        $('#errorhelpBlock').show();
        $('#starthelpBlock').hide();
        $('#successhelpBlock').hide();

        $('#prod_name').html("");
        $('#prod_stock').html("");
        $('#prod_size').html("");
        $('#prod_brand').html("");
        $('#prod_category').html("");

        temp_response = ""

      }else{
        $('#form-group').attr('class', 'form-group has-success');
        $('#starthelpBlock').hide();
        $('#successhelpBlock').show();
        $('#errorhelpBlock').hide();
        $('#save').attr('disabled',false);

        temp_response = response;

        $('#prod_name').html(response.inventory[0].strProductName + "  " + response.inventory[0].strVariant + "  " + response.inventory[0].intSize  + response.inventory[0].strUnitName);
        // $('#prod_stock').html(response.inventory[0].totalQty);
        // $('#prod_stock2').val(response.inventory[0].totalQty);
        $('#prod_brand').html(response.inventory[0].strBrand);
        $('#prod_price').html(response.inventory[0].productPrice.toFixed(2));
        $('#inventory').val(response.inventory[0].intInventoryNo);



      }
    })
  });



  $('#save').on('click',function(){

    var t = $('#example3').DataTable();
    var table = document.getElementById("example3");
    var row = table.getElementsByTagName("tr");

        t.row.add( [
          `<input type="hidden" class="form-control" value="${temp_response.inventory[0].intInventoryNo}" name="product[]">
          <img = width="40px" height="40px" src="/assets/images/products/${temp_response.inventory[0].strProductPicture}">`,
            `${temp_response.inventory[0].strProductName} ${temp_response.inventory[0].strVariant} ${temp_response.inventory[0].intSize} ${temp_response.inventory[0].strUnitName}`,
            `${temp_response.inventory[0].productPrice.toFixed(2)} <input type="hidden" value="${temp_response.inventory[0].productPrice.toFixed(2)}" class="price">`,
            `<input type="number" name="quantity[]" class="quantity form-control">`,
            `<button class="deleteRow large ui red button"> <i class="glyphicon glyphicon-trash"></i></button>`
        ] ).draw( false );

        $('.deleteRow').on('click',function(){

          $(this).closest('tr').find('input').each(function(){
            $(this).removeAttr('name')

          })
          $(this).closest('tr').remove();

        })

        $('.quantity').on('keyup',function(){
          var totalValue = 0;

          $('table').find('input.quantity').each(function(){
            totalValue = parseInt(totalValue) +  ($(this).val() * parseInt($(this).closest('tr').find('input.price').val()));
          })
          $('#suggestedPrice').val(totalValue)

        })

  })


</script>





<!-- Optionally, you can add Slimscroll and FastClick plugins.
     Both of these plugins are recommended to enhance the
     user experience. -->
</body>
</html>
